# 飞书一键建单 - 权限与注册指南

本文档详细说明如何完成飞书多维表到 TAPD 一键建单功能的配置。

---

## 📋 目录

1. [整体架构](#整体架构)
2. [TAPD 配置](#tapd-配置)
3. [飞书多维表配置](#飞书多维表配置)
4. [服务部署](#服务部署)
5. [测试验证](#测试验证)

---

## 🏗️ 整体架构

```
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│   飞书多维表    │ ──→  │   Webhook服务   │ ──→  │   TAPD API    │
│   (按钮点击)   │ HTTP │   (本服务)      │ HTTP │   (创建工单)   │
└────────────────┘      └────────────────┘      └────────────────┘
        │                       │                       │
    用户操作              处理字段映射              返回工单ID/URL
                         图片嵌入描述
```

---

## ⚙️ TAPD 配置

### 1. 获取 TAPD API 凭证

#### 步骤 1：进入 API 设置页面

1. 登录 TAPD：https://www.tapd.cn
2. 进入你的项目
3. 点击右上角 **设置** → **API 凭证**
4. 或直接访问：`https://www.tapd.cn/company/open_api`

#### 步骤 2：创建 API 应用

1. 点击 **创建 API 应用**
2. 填写应用名称（如：飞书一键建单）
3. 选择需要的权限（见下方权限列表）
4. 保存后会获得：
   - **API 用户名**（api_user）：如 `gNxpkwrr`
   - **API 密码**（api_password）：如 `86EE396F-6733-051C-3BA9-1243A2E8AA36`

#### 步骤 3：获取项目 ID（workspace_id）

1. 进入 TAPD 项目
2. 查看浏览器地址栏 URL
3. URL 中的数字就是项目ID，如：
   - URL: `https://www.tapd.cn/41827997/prong/stories/...`
   - workspace_id: `41827997`

### 2. 所需 API 权限

| 权限名称 | 说明 | 必需 |
|---------|------|------|
| 需求创建 | 调用 `/stories` API 创建需求 | ✅ |
| 缺陷创建 | 调用 `/bugs` API 创建缺陷 | ✅ |
| 需求类别查询 | 获取 workitem_type_id | 可选 |
| 附件上传 | 上传图片附件 | 可选 |

### 3. API 文档参考

- TAPD 开放平台：https://www.tapd.cn/help/show#1120003271001000093
- 需求 API：https://www.tapd.cn/help/view#1120003271001000113
- 缺陷 API：https://www.tapd.cn/help/view#1120003271001000114

---

## 📊 飞书多维表配置

### 1. 准备多维表字段

在你的飞书多维表中添加以下字段：

#### 必要字段

| 字段名 | 类型 | 用途 |
|--------|------|------|
| 标题 | 文本 | 工单标题（必填）|
| 类型 | 单选 | 选择 "需求" 或 "缺陷" |
| 建单按钮 | 按钮 | 触发建单 |
| TAPD链接 | 超链接 | 存放返回的工单链接 |
| 建单状态 | 单选 | 成功/失败/待建单 |

#### 可选字段

| 字段名 | 类型 | 映射到 TAPD |
|--------|------|------------|
| 描述 | 多行文本 | description |
| 处理人 | 文本/人员 | owner / current_owner |
| 优先级 | 单选 | priority_label |
| 标签类型 | 单选 | workitem_type_id + label |
| 严重程度 | 单选 | severity (仅缺陷) |
| 图片/截图 | 附件/URL | 嵌入描述 |

### 2. 配置按钮自动化

#### 步骤 1：创建自动化流程

1. 打开多维表 → 点击右上角 **"自动化"**
2. 点击 **"新建自动化"**

#### 步骤 2：设置触发器

1. 触发器类型：**点击按钮时**
2. 选择字段：选择你的 "建单按钮" 字段

#### 步骤 3：添加 HTTP 请求动作

1. 添加动作 → 选择 **"发送 HTTP 请求"**
2. 配置如下：

| 配置项 | 值 |
|--------|-----|
| 请求方法 | POST |
| URL | `http://你的服务器IP:8080/webhook/feishu` |
| Content-Type | application/json |

**请求体示例：**

```json
{
  "ticket_type": "{{类型}}",
  "标题": "{{标题}}",
  "描述": "{{描述}}",
  "处理人": "{{处理人}}",
  "标签类型": "{{标签类型}}",
  "图片": "{{截图}}"
}
```

> 💡 点击输入框右侧的 `{}` 图标可以插入当前记录的字段值

#### 步骤 4：添加更新记录动作

在 HTTP 请求后添加 **"更新记录"** 动作：

**配置 TAPD链接 字段：**

| 配置项 | 值 |
|--------|-----|
| 文本 | 查看TAPD单据 |
| 链接 | `{{第二步.发送请求返回值.data.ticket_url}}` |

**配置 建单状态 字段：**

- 条件判断：如果 `{{第二步.发送请求返回值.status}}` 等于 "success"
- 更新为："成功"
- 否则："失败"

---

## 🚀 服务部署

### 方式一：本地运行（测试）

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置
# 复制 app_config.example.json 为 app_config.json
# 填写你的 TAPD API 凭证

# 3. 运行
python main.py --port 8080
```

### 方式二：使用环境变量

```bash
# 设置环境变量
set TAPD_API_USER=你的API用户名
set TAPD_API_PASSWORD=你的API密码
set TAPD_WORKSPACE_ID=你的项目ID

# 运行
python main.py
```

### 方式三：生产环境部署

#### Docker 部署（推荐）

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY . .
RUN pip install -r requirements.txt

EXPOSE 8080

CMD ["python", "main.py", "--host", "0.0.0.0", "--port", "8080"]
```

```bash
# 构建镜像
docker build -t feishu-tapd .

# 运行容器
docker run -d \
  -p 8080:8080 \
  -e TAPD_API_USER=xxx \
  -e TAPD_API_PASSWORD=xxx \
  -e TAPD_WORKSPACE_ID=xxx \
  feishu-tapd
```

#### 服务器直接部署

推荐使用 **Supervisor** 或 **systemd** 管理进程：

```ini
# /etc/supervisor/conf.d/feishu-tapd.conf
[program:feishu-tapd]
command=python /path/to/main.py
directory=/path/to/project
environment=TAPD_API_USER="xxx",TAPD_API_PASSWORD="xxx",TAPD_WORKSPACE_ID="xxx"
autostart=true
autorestart=true
user=www-data
```

### 网络要求

1. **服务器必须有公网IP**（或配置内网穿透）
2. 飞书多维表发送的 HTTP 请求需要能访问到你的服务
3. 推荐使用 Nginx 反向代理 + HTTPS

---

## 🧪 测试验证

### 1. 健康检查

访问：`http://你的服务器:8080/health`

正常返回：
```json
{
  "status": "healthy",
  "config_valid": true
}
```

### 2. API 文档

访问：`http://你的服务器:8080/docs`

可以在 Swagger UI 中直接测试 API。

### 3. 手动测试

使用 curl 或 Postman 测试：

```bash
curl -X POST http://localhost:8080/api/create/story \
  -H "Content-Type: application/json" \
  -d '{
    "标题": "测试需求",
    "描述": "这是一个测试需求",
    "处理人": "张三",
    "标签类型": "PROGRAM"
  }'
```

### 4. 飞书端测试

1. 在多维表中添加一条测试记录
2. 点击建单按钮
3. 检查：
   - TAPD 中是否创建了工单
   - 多维表的 TAPD链接 字段是否更新
   - 多维表的建单状态 是否更新为"成功"

---

## 🔧 故障排除

### 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 请求超时 | 服务器不可达 | 检查网络/防火墙 |
| 401 错误 | TAPD 认证失败 | 检查 API 用户名和密码 |
| 标题为空错误 | 字段映射问题 | 检查飞书请求体中的字段名 |
| 图片不显示 | 图片URL无法访问 | 确保图片URL公网可访问 |

### 查看日志

服务运行时会输出详细日志，包括：
- 收到的请求内容
- 处理结果
- 错误信息

---

## 📁 项目文件说明

```
飞书一键建单/
├── main.py              # 主入口程序（Web服务）
├── config.py            # 配置管理模块
├── field_mapper.py      # 字段映射模块
├── image_handler.py     # 图片处理模块
├── webhook_service.py   # Webhook处理模块
├── tapd.py              # TAPD API客户端
├── requirements.txt     # Python依赖
├── app_config.json      # 配置文件（需自行创建）
└── app_config.example.json  # 配置文件示例
```

---

## 📞 需要的信息汇总

在配置前，请准备好以下信息：

| 项目 | 来源 | 示例值 |
|------|------|--------|
| TAPD API 用户名 | TAPD设置页面 | gNxpkwrr |
| TAPD API 密码 | TAPD设置页面 | 86EE396F-xxxx-xxxx |
| TAPD 项目 ID | TAPD URL | 41827997 |
| 服务器公网IP | 你的服务器 | 123.45.67.89 |
| 服务端口 | 自定义 | 8080 |

---

## ✅ 配置清单

- [ ] 获取 TAPD API 凭证
- [ ] 获取 TAPD 项目 ID
- [ ] 创建 app_config.json 配置文件
- [ ] 部署并启动服务
- [ ] 测试服务健康检查
- [ ] 在飞书多维表中添加必要字段
- [ ] 创建飞书自动化流程
- [ ] 端到端测试建单流程
